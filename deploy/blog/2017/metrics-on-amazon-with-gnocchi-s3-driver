<!DOCTYPE html>
<html lang="en">
  <head>
        <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Scalable metrics storage: Gnocchi on Amazon Web Services | Julien Danjou</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Jason W. Sidabras">

    <link href="/media/css/bootstrap.min.css" rel="stylesheet">
    <link href="/media/css/style.css" rel="stylesheet">


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
    <script>window.jQuery || document.write('<script src="../../assets/js/vendor/jquery.min.js"><\/script>')</script>
    <script src="/media/js/libs/bootstrap.min.js"></script>
 
   <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
        <!-- fonts -->
    <link href='http://fonts.googleapis.com/css?family=Nunito:300,400,700' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Raleway:400,300,500,600,700' rel='stylesheet' type='text/css'>
    <link href='/media/css/font-awesome.min.css' rel="stylesheet" type="text/css">
    <link href='/media/css/academicons.min.css' rel="stylesheet" type="text/css">
    <!-- nfonts -->
        
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-25393581-1', 'auto', {'allowLinker': true});
        ga('send', 'pageview');
    </script>


        <link rel="shortcut icon" href="/favicon.ico">
    <link rel="icon" type="image/png" href="/favicon.png" sizes="32x32">
    
        
      </head>

  <body class="metrics-on-amazon-with-gnocchi-s3-driver">
        <!-- start main wrapper -->
        <div id="header"><!-- start main header -->
            <div class="top-line">&nbsp;</div>
                <div class="top"><!-- top -->
                    <div class="container">
                        <div class="media-top-right">
                            <ul class="media-top clearfix">
                                <li class="item"><a href="https://www.linkedin.com/in/jason-sidabras-596466b6" target="blank"    ><i class="fa fa-linkedin-square ai-2x"></i></a></li>
                                <li class="item"><a href="https://scholar.google.com/citations?user=pbXGcaoAAAAJ" target="blank"><i class="ai ai-google-scholar ai-2x"></i></a></li>
                            </ul>
                            <div class="clearfix"></div>
                        </div>
                    </div>
                </div><!-- top -->
                <div class="container"><!-- container -->
                    <div class="row">
                        <div class="col-md-5"><!-- logo -->
                            <a href="index.html" title="Job Board" rel="home">
                                <img class="main-logo" style="margin-left: 20px; width: 75%;" src="/media/img/ActEPRLogo.png" alt="Act-EPR" />
                            </a>
                            <br />
                            <br />
                        </div><!-- logo -->
                    </div>
                    <div class="row">
                        <div class="col-md-8  main-nav"><!-- Main Navigation -->
                            <a id="touch-menu" class="mobile-menu" href="#"><i class="fa fa-bars fa-2x"></i></a>
                            <nav>
                                <ul class="menu">
                                    <li><a href="/">HOME</a></li>
                                    <li><a  href="#">WORK PACKAGES</a>
                                        <ul class="sub-menu">
                                            <li><a href="#">WP1 Micro-Helix Resonators</a></li>
                                            <li><a href="#">WP2 Technology Advancements</a></li>
                                            <li><a href="#">WP3 Biological Research</a></li>
                                        </ul>
                                    </li>
                                    <li><a  href="/publications.html">PUBLICATIONS</a></li>
                                    <li><a  href="/blog/">BLOG</a></li>
                                    <li><a  href="#">ABOUT</a></li>
                                </ul>
                            </nav>
                        </div><!-- Main Navigation -->
                        <div class="clearfix"></div>
                    </div>
                </div><!-- container -->
            </div><!-- end main header -->
            <br />
            <div class="container"><!-- Container -->
                <div class="row">
                    <div class="container" id="top">
        <div class="col-md-8 col-md-offset-1">
    <header>
    <h1>Scalable metrics storage: Gnocchi on Amazon Web Services</h1>
      <div class="meta">
        <small><i class="fa fa-calendar"></i>Wednesday 22 February 2017</small>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <small>
          <i class="fa fa-folder"></i>
                      <a href="/blog/tags/Amazon Web Services.html">Amazon Web Services</a>,                      <a href="/blog/tags/Gnocchi.html">Gnocchi</a>                  </small>
      </div>
      <hr style="margin-bottom: 2em;" />
    </header>
            <p>As I wrote a few weeks ago in
my <a href="/blog/2017/gnocchi-3.1-release">post about Gnocchi 3.1 being released</a>, one
of the new feature available in this version it
the <a href="https://aws.amazon.com/s3/">S3</a> driver. Today I would like to show you how
easy it is to use it and store millions of metrics into the simple, durable and
massively scalable object storage provided
by <a href="https://aws.amazon.com/">Amazon Web Services</a>.</p>
<h1>Installation</h1>
<p>The installation of Gnocchi for this use case is not different than
the
<a href="http://gnocchi.xyz/install.html">standard installation procedure described in the documentation</a>.
Simply install Gnocchi from <a href="http://pypi.python.org">PyPI</a> using the following
command:</p>
<pre>
$ pip install gnocchi[s3,postgresql] gnocchiclient
</pre>

<p>This will install Gnocchi with the dependencies for the S3 and PostgreSQL
drivers and the command-line interface to talk with Gnocchi.</p>
<h1>Configuring Amazon RDS</h1>
<p>Since you need a SQL database for the indexer, the easiest way to get started
is to create a database on <a href="https://console.aws.amazon.com/rds/">Amazon RDS</a>.
You can create a managed <a href="http://postgresql.org">PostgreSQL</a> database instance
in just a few clicks.</p>
<p>Once you're on the homepage
of <a href="https://console.aws.amazon.com/rds/">Amazon RDS</a>, pick PostgreSQL as a
database:</p>
<figure class="illustration center">
  <img src="/media/images/blog/2017/gnocchi-rds-postgresql.png">
</figure>

<p>You can then configure your PostgreSQL instance: I've picked a dev/test
instance with the basic options available within the RDS Free Tier, but you can
pick whatever you think is needed for your production use. Set a username and a
password and note them for later: we'll need them to configure Gnocchi.</p>
<figure class="illustration center">
  <img src="/media/images/blog/2017/gnocchi-rds-postgresql-conf.png">
</figure>

<p>The next step is to configure the database in details. Just set the database
name to "gnocchi" and leave the other options to their default values (I'm
lazy).</p>
<figure class="illustration center">
  <img src="/media/images/blog/2017/gnocchi-rds-postgresql-details.png">
</figure>

<p>After a few minutes, your instance should be created and running. Note down the
endpoint. In this case, my instance is
<code>gnocchi.cywagbaxpert.us-east-1.rds.amazonaws.com</code>.</p>
<figure class="illustration center">
  <img src="/media/images/blog/2017/gnocchi-rds-postgresql-running.png">
</figure>

<h1>Configuring Gnocchi for S3 access</h1>
<p>In order to give Gnocchi an access to S3, you need to create access keys. The
easiest way to create them is to go
to <a href="https://console.aws.amazon.com/iam">IAM</a> in your AWS console, pick a user
with S3 access and click on the big gray button named "Create access key".</p>
<figure class="illustration center">
  <img src="/media/images/blog/2017/gnocchi-iam-create-keys.png">
</figure>

<p>Once you do that, you'll get the <em>access key id</em> and <em>secret access key</em>. Note
them down, we will need these later.</p>
<figure class="illustration center">
  <img src="/media/images/blog/2017/gnocchi-iam-get-keys.png">
</figure>

<h1>Creating <code>gnocchi.conf</code></h1>
<p>Now is time to create the <code>gnocchi.conf</code> file. You can place it in
<code>/etc/gnocchi</code> if you want to deploy it system-wide, or in any other directory
and add the <code>--config-file</code> option to each Gnocchi command..</p>
<p>Here are the values that you should retrieve and write in the configuration file:</p>
<ul>
<li><code>indexer.url</code>: the PostgreSQL RDS instance endpoint and credentials (see above) to set into</li>
<li><code>storage.s3_endpoint_url</code>: the S3 endpoint URL – that depends on the region you want
  to use and
  <a href="http://docs.aws.amazon.com/general/latest/gr/rande.html#s3_region">they are listed here</a>.</li>
<li><code>storage.s3_region_name</code>: the S3 region name matching the endpoint you
  picked.</li>
<li><code>storage.s3_access_key_id</code> and <code>storage.s3_secret_acess_key</code>: your AWS access
  key id and secret access key.</li>
</ul>
<p>Your <code>gnocchi.conf</code> file should then look like that:</p>
<div class="highlight"><pre><span></span><span class="k">[indexer]</span><br /><span class="na">url</span> <span class="o">=</span> <span class="s">postgresql://gnocchi:gn0cch1rul3z@gnocchi.cywagbaxpert.us-east-1.rds.amazonaws.com:5432/gnocchi</span><br />&nbsp;<br /><span class="k">[storage]</span><br /><span class="na">driver</span> <span class="o">=</span> <span class="s">s3</span><br /><span class="na">s3_endpoint_url</span> <span class="o">=</span> <span class="s">https://s3-eu-west-1.amazonaws.com</span><br /><span class="na">s3_region_name</span> <span class="o">=</span> <span class="s">eu-west-1</span><br /><span class="na">s3_access_key_id</span> <span class="o">=</span> <span class="s">&lt;you access key id&gt;</span><br /><span class="na">s3_secret_access_key</span> <span class="o">=</span> <span class="s">&lt;your secret access key&gt;</span><br /></pre></div>

<p><br />
Once that's done, you can run <code>gnocchi-upgrade</code> in order to initialize Gnocchi
indexer (PostgreSQL) and storage (S3):</p>
<pre>
$ gnocchi-upgrade --config-file gnocchi.conf
2017-02-07 15:35:52.491 3660 INFO gnocchi.cli [-] Upgrading indexer <gnocchi.indexer.sqlalchemy.SQLAlchemyIndexer object at 0x108221950>
2017-02-07 15:36:04.127 3660 INFO gnocchi.cli [-] Upgrading storage <gnocchi.storage.s3.S3Storage object at 0x10ca943d0>
</pre>

<p>Then you can run the API endpoint using the test endpoint <code>gnocchi-api</code> and
specifying its default port 8041:</p>
<pre>
$ gnocchi-api --port 8041 -- --config-file gnocchi.conf
2017-02-07 15:53:06.823 6290 INFO gnocchi.rest.app [-] WSGI config used: /Users/jd/Source/gnocchi/gnocchi/rest/api-paste.ini
********************************************************************************
STARTING test server gnocchi.rest.app.build_wsgi_app
Available at http://127.0.0.1:8041/
DANGER! For testing only, do not use in production
********************************************************************************
</pre>

<p>The best way to run Gnocchi API is to
use
<a href="http://gnocchi.xyz/master/running.html#running-api-as-a-wsgi-application">uwsgi as documented</a>,
but in this case, using the testing daemon <code>gnocchi-api</code> is good enough.</p>
<p>Finally, in another terminal, you can start the <code>gnocchi-metricd</code> daemon that
will process metrics in background:</p>
<pre>
$ gnocchi-metricd --config-file gnocchi.conf
2017-02-07 15:52:41.416 6262 INFO gnocchi.cli [-] 0 measurements bundles across 0 metrics wait to be processed.
</pre>

<p>Once everything is running, you can use Gnocchi's client to query it and check
that everything is OK. The backlog should be empty at this stage, obviously.</p>
<pre>
$ gnocchi status
+-----------------------------------------------------+-------+
| Field                                               | Value |
+-----------------------------------------------------+-------+
| storage/number of metric having measures to process | 0     |
| storage/total number of measures to process         | 0     |
+-----------------------------------------------------+-------+
</pre>

<p>Gnocchi is ready to be used! </p>
<pre>
$ # Create a generic resource "foobar" with a metric named "visitor"
$ gnocchi resource create foobar -n visitor
+-----------------------+-----------------------------------------------+
| Field                 | Value                                         |
+-----------------------+-----------------------------------------------+
| created_by_project_id |                                               |
| created_by_user_id    | admin                                         |
| creator               | admin                                         |
| ended_at              | None                                          |
| id                    | b4d568e4-7af1-5aec-ac3f-9c09fa3685a9          |
| metrics               | visitor: 05f45876-1a69-4a64-8575-03eea5b79407 |
| original_resource_id  | foobar                                        |
| project_id            | None                                          |
| revision_end          | None                                          |
| revision_start        | 2017-02-07T14:54:54.417447+00:00              |
| started_at            | 2017-02-07T14:54:54.417414+00:00              |
| type                  | generic                                       |
| user_id               | None                                          |
+-----------------------+-----------------------------------------------+

# Send the number of visitor at 2 different timestamps
$ gnocchi measures add --resource-id foobar -m 2017-02-07T15:56@23 visitor
$ gnocchi measures add --resource-id foobar -m 2017-02-07T15:57@42 visitor

# Check the average number of visitor
# (the --refresh option is given to be sure the measure are processed)
$ gnocchi measures show --resource-id foobar visitor --refresh
+---------------------------+-------------+-------+
| timestamp                 | granularity | value |
+---------------------------+-------------+-------+
| 2017-02-07T15:55:00+00:00 |       300.0 |  32.5 |
+---------------------------+-------------+-------+

# Now shows the minimum number of visitor
$ gnocchi measures show --aggregation min --resource-id foobar visitor
+---------------------------+-------------+-------+
| timestamp                 | granularity | value |
+---------------------------+-------------+-------+
| 2017-02-07T15:55:00+00:00 |       300.0 |  23.0 |
+---------------------------+-------------+-------+
</pre>

<p>And voilà! You're ready to store millions of metrics and measures on your
Amazon Web Services cloud platform. I hope you'll enjoy it and feel free to ask
any question in the comment section or by reaching me directly!</p>          </div>

  </div>
            
                </div> <!-- /row-->
            </div> <!-- /container -->
        </div>
    
    <div id="footer"><!-- Footer -->
        <div class="container"><!-- Container -->
            <div class="row">
                <div style="margin-left: 60px;" class="col-md-5 footer-widget"><!-- Text Widget -->
                    <h6 class="widget-title">Acknowledgements</h6>
                        <div class="textwidget">
                            <a href="http://ec.europa.eu/research/participants/portal/desktop/en/home.html">
                              <img src="/media/img/logo_EUh2020_horizontal.png" />
                            </a>
                            <br /><br />
                            <a href="https://cec.mpg.de/home/">
                              <img src="/media/img/csm_mpi-logo.png" />
                            </a>
                        </div>

                </div><!-- Text Widget -->

                <div style="margin-right:20px;" class="col-md-3 footer-widget"><!-- Recent Tweet Widget -->
                    <h6 class="widget-title">Links of Interest</h6>
                    <div class="recent-twitt">
                    <p class="textwidget" style="text-align: justify;">
                        <a style="color: #f0ce42;" href="https://cec.mpg.de/biophysikalische-chemie/dr-edward-j-reijerse/">Bio Hydrogen Group</a> - Led by Dr. Edward J. Reijerse, the Bio Hydrogen Group looks to understand the chemical reaction of biological hydrogenase in order to create bio-inspired molecular catalysts. 
                    </p>
                </div>
            </div><!-- Recent Tweet Widget -->

            <div class="col-md-3 footer-widget"><!-- News Leter Widget -->
                <h6 class="widget-title">News</h6>
                <div class="textwidget">
                    <p>Act-EPR project starts on 1st May, 2017.</p>
                </div>
            </div><!-- News Leter Widget -->
            <div class="clearfix"></div>
        </div>

        <div class="footer-credits"><!-- Footer credits -->
            2017 &copy; Jason W. Sidabras
        </div><!-- Footer credits -->
    </div><!-- Container -->
</div><!-- Footer -->

</div><!-- end main wrapper -->
 </body>
</html>